---
output: github_document
---

```{r, echo = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "figs/",
  fig.align = "center"
)
```

[\@drsimonj](https://twitter.com/drsimonj) here to explain my recent contribution to the [broom](https://cran.r-project.org/web/packages/broom/index.html) package, for helping to tidy factor analysis objects in R created using `factanal()`.

## broom

The package author, [David Robinson](https://twitter.com/drob), describes broom as:

> The broom package takes the messy output of built-in functions in R, such as lm, nls, or t.test, and turns them into tidy data frames. 

I first heard about [broom](https://cran.r-project.org/web/packages/broom/index.html) while putting together new driving stations in my VR simulation labs. I was fortunate to have the useR! 2016 conference streaming from Stanford in the background when David gave his presentation. After that, broom instantly became a must-have in my tidyverse toolbox!

If you're unfamiliar with broom, I suggest having a quick look at its [GitHub page](https://github.com/tidyverse/broom). Relevant here, broom tries to provide three functions for certain statistical models: `tidy`, `augment`, and `glance`.

## Factor Analysis tidiers

I noticed that broom did not support factor analysis models generated via `factanal`. So, I'm proud to say that I've contributed to broom by including `tidy`, `augment`, and `glance`, methods that work with `factanal` objects. Below are some examples that demonstrate each of these methods.

For each, let's run a 3-factor model on the `mtcars` data set. Make sure to obtain factor scores using the `scores` argument:

```{r}
mod <- factanal(mtcars, 3, scores = "regression")
```

Like many of the model functions in R, `factanal` returns apretty messy result:

```{r}
mod
```

Let's examine how to make our lives easier with the new methods included in broom.

## tidy

`tidy` will summarise in a data frame the uniqueness and factor loadings of each variable used in the analysis:

```{r}
library(broom)
tidy(mod)
```

This makes it easy to do things like visualise the variables that were not well accounted for by the analysis via the `uniqueness` values:

```{r}
library(dplyr)
library(ggplot2)

tidy_data <- tidy(mod)
ggplot(tidy_data, aes(x = variable, y = uniqueness)) +
  geom_bar(stat = "identity") +
  coord_flip()
```


Following the example included in the documentation provided for this method (`?tidy.factanal`) will generate the following plot:

```{r, echo = F, message = F}
library(dplyr)
library(tidyr)
library(ggplot2)

tidy(mod) %>% 
    select(-uniqueness) %>% 
    gather(factor, loading, -variable) %>% 
    mutate(factor = gsub("fl", "", factor),
           sign = ifelse(sign(loading) == 1, "b", "a"),
           loading = abs(loading)) %>% 
    group_by(factor) %>% 
    arrange(factor, desc(loading)) %>% 
    mutate(order = 1:n()) %>% 
    ungroup() %>% 
    ggplot(aes(x = factor, y = loading, group = order)) +
    geom_bar(aes(fill = sign, alpha = loading),
             stat = "identity", position = "dodge", color = "black",
             show.legend = FALSE) +
    geom_text(aes(label = variable, group = order),
              position = position_dodge(width = 0.9),
              size = 3.5, angle = 45, hjust = -.4) +
    scale_fill_brewer(palette = "Set1") +
    theme_bw() +
    labs(
        x = "Factor",
        y = "Loading",
        title = "Positive (blue) and negative (red) factor loadings of all variables"
    )
```


## Sign off

Thanks for reading and I hope this was useful for you.

For updates of recent blog posts, follow [\@drsimonj](https://twitter.com/drsimonj) on Twitter, or email me at <drsimonjackson@gmail.com> to get in touch.

If you'd like the code that produced this blog, check out the [blogR GitHub repository](https://github.com/drsimonj/blogR).