---
output: github_document
---

```{r, echo = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  echo = FALSE,
  warning = FALSE,
  message = FALSE,
  fig.path = "figs/",
  #fig.height = 3,
  #fig.width = 6,
  fig.align = "center"
)
```

```{r ggplot_theme}
# Modified version of theme_bw() from source code at
# https://github.com/hadley/ggplot2/blob/master/R/theme-defaults.r
library(ggplot2)
theme_post <- function(base_size = 11, base_family = "") {
  # Starts with theme_grey and then modify some parts
  theme_grey(base_size = base_size, base_family = base_family) %+replace%
    theme(
      # white background and dark border
      panel.background = element_rect(fill = "white", colour = NA),
      #panel.border     = element_rect(fill = NA, colour = "grey20"),
      
      # Add black lines to x and y axes
      axis.line.x = element_line(colour = "black", size = 1),
      axis.line.y = element_line(colour = "black", size = 1),
      
      # make gridlines dark, same contrast with white as in theme_grey
      panel.grid.major = element_line(colour = "grey92"),
      panel.grid.minor = element_line(colour = "grey92", size = 0.25),
      # contour strips to match panel contour
      strip.background = element_rect(fill = "grey85", colour = "grey20"),
      # match legend key to background
      legend.key       = element_rect(fill = "white", colour=NA),

      complete = TRUE
    )
}

```


[\@drsimonj](https://twitter.com/drsimonj) here to discuss mortality-related variables as causes and effects of changing healthcare expenditure. I hope that you find the content to be as equally interesting as I do. However, for the most part, please consider this post to be an informative exercise of exploring data with R.

## Healthcare expenditure correlates with mortality-related variables

This post was inspired by the Figure below which appears on [this OurWorldInData.org page](https://ourworldindata.org/financing-healthcare/#correlates-determinants-consequences).

<center><image src="https://ourworldindata.org/wp-content/uploads/2016/04/health-exp-vs-u5mr-with-labels-1.png" /></center>

The Figure, which was brought to my attention by [this Tweet by Bill Gates](https://twitter.com/BillGates/status/763412096382009346), clearly shows that child mortality rates and health expenditure per capita are negatively correlated. The lower one of these is, the higher the other. More specifically, the Figure shows that, over time (from 1995 to 2014), child morality rates have been declining while healthcare expenditure has been increasing.

From the same web page, another powerful Figure is the one below, which shows how healthcare expenditure and life expectancy from birth relate.

<center><image src="https://ourworldindata.org/wp-content/uploads/2016/04/health-exp-vs-life-expectancyl.png" /></center>

The relationship is positive this time. That is, higher life expectancy corresponds to higher health expenditure. Furthermore, life expectancy has been increasing over time.

## But we can't yet say that healthcare expenditure causes changes in mortality-related variables

A tempting thought after looking at these Figures is that changes in healthcare expenditure are **causing** the changes in child mortality rates and life expectancy over time. This would mean that a country can decrease child mortality or increase life expectancy by increasing their expenditure on healthcare.

However, the OurWorldInData.org team don't claim this, and instead refer to child mortality and life expectancy as "correlates" of healthcare expenditure. Why? Because any good scientist or statistician will remind you that "correlation does not imply causation". For example, it's possible that countries change healthcare expenditure in a reactionary manner, such that they increase healthcare expenditure after deciding that their child mortality has been too high or life expectancy too low. This scenario could also explain the Figures above. The point is, we cannot necessarily imply which variables cause the others simply by observing that they are correlated.

If you remain unconvinced, or feel like a laugh, [here's a site with Figures](https://www.fastcodesign.com/3030529/infographic-of-the-day/hilarious-graphs-prove-that-correlation-isnt-causation/5) of variables that seem to correlate but clearly don't cause one another.

## Establishing cause and effect with time

In addition to correlation, establishing a causal relationship involves demonstrating temporal precendence. That is, a cause should always come before an effect in time.

Say we hypothesise that changing healthcare expenditure **causes** changes in child mortality rates or life expectancy. Good evidence of this would be that a change in healthcare expenditure corresponds to **future** changes in child mortality rates or life expectancy. An alternative way to phrase this would be that differences in child mortality and life expectancy correspond to **past** changes in healthcare expenditure. To exagerate the point, we might expect to see something like the following:

```{r}
library(tidyverse)

# Generate data
d <- tibble(
  health_inc = rep(c(1, -1), each = 3),
  year = rep(c(0:2), 2)
)
d <- d %>% mutate(child_mort = year * health_inc / 5,
                  year = factor(year),
                  health_inc = factor(health_inc))

ggplot(d, aes(x = year, y = child_mort, group = health_inc, color = health_inc)) +
  geom_line() +
  scale_color_manual(
    values = c("dodgerblue4", "brown2"),
    name = "Did healthcare expenditure\nincrease at time 0?",
    breaks = c(1, -1),
    labels = c("Increased", "Decreased")
  ) +
  theme_post() +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank()) +
  scale_x_discrete(expand = c(0,0)) +
  labs(
    x = expression(paste(symbol('\256'), " Time ", symbol('\256'))),
    y = expression(paste(symbol('\256'), " Child Mortality Rate ", symbol('\256'))),
    title = "Hypothesised change in\nchild mortality over time"
  )
```

This Figure hypothesises that countries who increase their healthcare expenditure at a particular time (time 0), see future declines in child mortality, while countries that decrease their healthcare expenditure see future increases in child mortality.

This has been exagerted to make a point, however. It's probably fair to say that many other factors affect child mortality in addition to healthcare expenditure. Given the general trend of child mortality to decline over time, we might expect to see the following:

```{r}
# Generate data
d <- tibble(
  health_inc = rep(c(-.7, -1), each = 3),
  year = rep(c(0:2), 2)
)
d <- d %>% mutate(child_mort = year * health_inc / 5,
                  year = factor(year),
                  health_inc = factor(health_inc))

ggplot(d, aes(x = year, y = child_mort, group = health_inc, color = health_inc)) +
  geom_line() +
  scale_color_manual(
    values = c("dodgerblue4", "brown2"),
    name = "Did healthcare expenditure\nincrease at time 0?",
    breaks = c(-1, -.7),
    labels = c("Increased", "Decreased")
  ) +
  theme_post() +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank()) +
  scale_x_discrete(expand = c(0,0)) +
  labs(
    x = expression(paste(symbol('\256'), " Time ", symbol('\256'))),
    y = expression(paste(symbol('\256'), " Child Mortality Rate ", symbol('\256'))),
    title = "Hypothesised change in\nchild mortality over time"
  )
```

This Figure hypothesises that while child mortality decreases over time for all countries, the decrease is greater for countries who increased their healthcare expenditure in the past (at time 0).

The point of these two hypothetical Figures is that, regardless of the specifics, if differences in one variable can be linked to past or future changes in another, this provides evidence in favour of a causal relation.

## Exploring changes in time

To investigate whether a casual relationship exists betwee healthcare expenditure and mortality-related variables, let's start by examining change over time. From here, we'll be using data available in the new [ourworldindata package for R](https://github.com/drsimonj/ourworldindata), which you can learn more about in a [previous blogR post](https://goo.gl/1EQX94). Complete data is available from 1995 to 2013 for 174 countreis.

```{r data_setup}
library(tidyverse)
library(ourworldindata)
library(forcats)
library(stringr)

# Select data and group by country
d <- financing_healthcare %>%
  select(year:continent, health_exp_total, child_mort, life_expectancy) %>% 
  drop_na() %>% 
  group_by(country)

# There are a few countries that don't start in 1995, but all end in 2013
# So remove these few countries that don't have data back to 1995:
d <- d %>% filter(first(year) == 1995)
```

### Values over time

The following Figures show healthcare expenditure, child mortality, and life expectancy over time. Thin lines represent countries. Thick lines represent the average of all countries in a given world region.

```{r}
# Yearly healthcare expenditure
sum_d <- d %>% 
  group_by(year, continent) %>% 
  summarise(health_exp_total = mean(health_exp_total))

d %>% 
  ggplot(aes(x = year, y = health_exp_total, color = continent)) +
  geom_line(aes(group = country), alpha = .1) +
  geom_line(data = sum_d, size = 2, alpha = .5) +
  scale_colour_brewer(palette = "Set1") +
  theme_post() +
  scale_x_continuous(expand = c(0,0), breaks = seq(1995, 2013, 2)) +
  scale_y_continuous(expand = c(0,0), labels = scales::dollar) +
  labs(
    title = "Health expenditure is increasing over time",
    x = NULL,
    y = "Health expenditure",
    color = "World region"
  )

# Child mortality
sum_d <- d %>% 
  group_by(year, continent) %>% 
  summarise(child_mort = mean(child_mort))

d %>% 
  ggplot(aes(x = year, y = child_mort, color = continent)) +
  geom_line(aes(group = country), alpha = .1) +
  geom_line(data = sum_d, size = 2, alpha = .5) +
  scale_colour_brewer(palette = "Set1") +
  theme_post() +
  scale_x_continuous(expand = c(0,0), breaks = seq(1995, 2013, 2)) +
  scale_y_continuous(expand = c(0,0)) +
  labs(
    title = "Child mortality is decreasing over time",
    x = NULL,
    y = "Child mortality rate",
    color = "World region"
  )

# Life expectancy
sum_d <- d %>% 
  group_by(year, continent) %>% 
  summarise(life_expectancy = mean(life_expectancy))

d %>% 
  ggplot(aes(x = year, y = life_expectancy, color = continent)) +
  geom_line(aes(group = country), alpha = .1) +
  geom_line(data = sum_d, size = 2, alpha = .5) +
  scale_colour_brewer(palette = "Set1") +
  theme_post() +
  scale_x_continuous(expand = c(0,0), breaks = seq(1995, 2013, 2)) +
  scale_y_continuous(expand = c(0,0)) +
  labs(
    title = "Life expectancy is increasing over time",
    x = NULL,
    y = "Life expectancy",
    color = "World region"
  )
```

They tell us what we already know: that healthcare expenditure and life expectancy have been increasing over time, and child mortality has been decreasing.

Yet an important thing to note, which is also visible in the OurWorldInData.org Figures, is that there are considerable differences between countries. That is, altought the trends are similar for most countries, they can differ greatly in the overall level of the variable. For example, African nations stand out as having a much higher level of child mortality.

### Percentage change to account for between-country differences

The problem is that we're not paricularly interested in these differences between countries. Instead, we're interested in the changes that happen over time within a country. For example, if a country increases its healthcare expenditure in 2002, does the child mortality rate decline in future years?

This problem can be handled using statistical model that nest data within countries, but I'd prefer to keep it simple/interpretable and take a visual approach. So, here, we'll start to talk about the percentage change in healthcare expenditure, child mortality, and life expectancy, from one year to another. To illustrate, the below Figure plots child mortality rates over time for three countries:

```{r}
d %>% 
  filter(country %in% c("United States", "Australia", "Algeria")) %>% 
  ggplot(aes(x = year, y = child_mort, group = country, color = country)) +
  geom_line() +
  scale_colour_brewer(palette = "Set1") +
  theme_post() +
  scale_x_continuous(expand = c(0,0), breaks = seq(1995, 2013, 2)) +
  scale_y_continuous(expand = c(0,0)) +
  labs(
    title = "Child mortality rate",
    x = NULL,
    y = "Child mortality rate",
    color = "Country"
  )
```

Clearly, Algeria has a much higher rate of child mortality that Australia or the United states. Instead, let's plot the child mortality rate for each country as the percentage change compared to each countrys' own rate in 2002. This means that 0% on the y axis indicates no change from the 2002 child mortality rate (meaning the line for every country will intersect at 0% in 2002), a positive percent means a higher rate than in 2002, and a negative percent means a lower rate than in 2002.

```{r}
# Compute `health_exp_change` which is the change from previous year as a
# proportion of previous year's spending. 0 means no change. positive means
# increase, negative means decrease.
d <- d %>% mutate(health_exp_change = (health_exp_total - lag(health_exp_total)) / lag(health_exp_total))

# Compute every year-to-year comparison for `child_mort` and `life_expectancy`. 
# That is, for every year, what is the change from it to every other year as a
# proportion of that given year's value.
add_cm_lead <- function(lead_by) {
  d %>% mutate_(.dots = setNames(list(~ (lead(child_mort, lead_by) - child_mort) / child_mort),  paste0("child_mort_", lead_by)))
}

add_cm_lag <- function(lag_by) {
  d %>% mutate_(.dots = setNames(list(~ (lag(child_mort, lag_by) - child_mort) / child_mort),  paste0("child_mort_-", lag_by)))
}

add_le_lead <- function(lead_by) {
  d %>% mutate_(.dots = setNames(list(~ (lead(life_expectancy, lead_by) - life_expectancy) / life_expectancy),  paste0("life_expectancy_", lead_by)))
}

add_le_lag <- function(lag_by) {
  d %>% mutate_(.dots = setNames(list(~ (lag(life_expectancy, lag_by) - life_expectancy) / life_expectancy),  paste0("life_expectancy_-", lag_by)))
}

year_span <- max(summarise(d, year_span = max(year) - min(year))$year_span)

# Add child mortality comparison to future years
d <- map(0:year_span, add_cm_lead) %>% reduce(left_join)
# Add child mortality comparison to past years
d <- map(1:year_span, add_cm_lag) %>% reduce(left_join)
# Add life expectancy comparison to future years
d <- map(0:year_span, add_le_lead) %>% reduce(left_join)
# Add life expectancy comparison to past years
d <- map(1:year_span, add_le_lag) %>% reduce(left_join)

# Tidy
d <- d %>%
  select(-child_mort, -life_expectancy) %>% 
  gather(key, value, contains("child_mort"), contains("life_expectancy")) %>%
  extract(key, c("var", "comparison_year"), "(child_mort|life_expectancy)_(.*)") %>%
  spread(var, value) %>% 
  mutate(comparison_year = year + as.numeric(comparison_year))

d %>% 
  filter(country %in% c("United States", "Australia", "Algeria") & year == 2002) %>% 
  ggplot(aes(x = comparison_year, y = child_mort, group = country, color = country)) +
  geom_vline(xintercept = 2002) +
  geom_hline(yintercept = 0)+
  annotate("text", x = 2008, y = .1, label = "All values relative to the\n2002 rate of each country") +
  geom_segment(aes(x = 2004, y = .1, xend = 2002, yend = 0), colour = 'darkorchid2', size = 1, arrow = arrow()) +
  geom_line() +
  scale_colour_brewer(palette = "Set1") +
  theme_post() +
  scale_x_continuous(expand = c(0,0), breaks = seq(1995, 2013, 2), limits = c(1995, 2013)) +
  scale_y_continuous(expand = c(0,0), labels = scales::percent) +
  labs(
    title = "Child mortality as percentage change to 2002 rate",
    x = NULL,
    y = "Change in child mortality from 2002 rate",
    color = "Country"
  )
```

By converting the child mortality rate for each country to a percentage change from a common year, we can worry less about the huge between-country differences. For example, we can see that all three countries above had a child mortality rate about 10% - 15% higher in 1995 than in 2002, and the trends are all fairly equivalent (though the United States seems to be declining at a slower proportional rate).

To round this section off, here's the same Figure but including all countries coloured by their world region:

```{r}
sum_d <- d %>% 
  filter(year == 2002) %>% 
  group_by(comparison_year, continent) %>% 
  summarise(child_mort = mean(child_mort))

d %>% 
  filter(year == 2002) %>% 
  ggplot(aes(x = comparison_year, y = child_mort, color = continent)) +
  geom_vline(xintercept = 2002) +
  geom_hline(yintercept = 0) +
  geom_line(aes(group = country), alpha = .1) +
  geom_line(data = sum_d, size = 2, alpha = .5) +
  scale_colour_brewer(palette = "Set1") +
  theme_post() +
  scale_x_continuous(expand = c(0,0), breaks = seq(1995, 2013, 2), limits = c(1995, 2013)) +
  scale_y_continuous(expand = c(0,0), labels = scales::percent) +
  labs(
    title = "Child mortality as percentage change to 2002 rate",
    x = NULL,
    y = "Change in child mortality from 2002 rate",
    color = "World Region"
  )
```


## Investigating Change in Healthcare

Now that we've got countries on a comparable scale, we can start to investigate the effect of healthcare expenditure. To do this, we'll recolour countries in the above plot by whether they increased their spending on healthcare in 2002 (i.e., compared to 2001, did healthcare expenditure in 2002 go up?). In this Figure, the thick lines represent the average for countries that did or did not increase their healthcare expenditure in 2002.

```{r, fig.width = 8.5, fig.height = 5}
d <- d %>% mutate(health_exp_increase = health_exp_change > 0)

sum_d <- d %>% 
  filter(year == 2002) %>% 
  group_by(comparison_year, health_exp_increase) %>% 
  summarise(child_mort = mean(child_mort))

d %>% 
  filter(year == 2002) %>% 
  ggplot(aes(x = comparison_year, y = child_mort, color = health_exp_increase)) +
  geom_vline(xintercept = 2002) +
  geom_hline(yintercept = 0) +
  geom_line(aes(group = country), alpha = .1) +
  geom_line(data = sum_d, size = 2, alpha = .5) +
  theme_post() +
  scale_x_continuous(expand = c(0,0), breaks = seq(1995, 2013, 2), limits = c(1995, 2013)) +
  scale_y_continuous(expand = c(0,0), labels = scales::percent) +
  labs(
    title = "Countries that increased healthcare expenditure in 2002\nhad higher rates of child mortality in the past\nbut lower rates of child mortality in the future\nthan countries that decreased their expenditure",
    x = NULL,
    y = "Change in child mortality from 2002 rate",
    color = NULL
  ) +
  scale_color_manual(
    values = c("brown2", "dodgerblue4"),
    breaks = c(TRUE, FALSE),
    labels = c("Increased healthcare\nexpenditure in 2002", "No change or decreased\nexpenditure in 2002")
  )
```

This looks similar to our hypothesised outcome if healthcare expenditure affected child mortality. Globally, child mortality rates declined after 2002. However, after 2002, there was agreater decline in child mortality for countries that increased their spending on health rather than countries that made no changes or decreasedtheir spending.

Let's do the same graph but examining life expectancy in terms of change from life expectancy in 2002:

```{r, fig.width = 8.5, fig.height = 5}
sum_d <- d %>% 
  filter(year == 2002) %>% 
  group_by(comparison_year, health_exp_increase) %>% 
  summarise(life_expectancy = mean(life_expectancy))

d %>% 
  filter(year == 2002) %>% 
  ggplot(aes(x = comparison_year, y = life_expectancy, color = health_exp_increase)) +
  geom_vline(xintercept = 2002) +
  geom_hline(yintercept = 0) +
  geom_line(aes(group = country), alpha = .1) +
  geom_line(data = sum_d, size = 2, alpha = .5) +
  theme_post() +
  scale_x_continuous(expand = c(0,0), breaks = seq(1995, 2013, 2), limits = c(1995, 2013)) +
  scale_y_continuous(expand = c(0,0), labels = scales::percent) +
  labs(
    title = "Countries that increased healthcare expenditure in 2002\nhad higher rates of child mortality in the past\nbut lower rates of child mortality in the future\nthan countries that decreased their expenditure",
    x = NULL,
    y = "Change in life expectancy from 2002",
    color = NULL
  ) +
  scale_color_manual(
    values = c("brown2", "dodgerblue4"),
    breaks = c(TRUE, FALSE),
    labels = c("Increased healthcare\nexpenditure in 2002", "No change or decreased\nexpenditure in 2002")
  )
```

## Mortality as a cause and effect of healthcare expenditure?

The above Figure suggests that child mortality is not only and effect, but also a cause of changes in healthcare expenditure. Why? Countries that increased their healthcare expenditure in 2002 had proportionally lower child mortality rates in the future than countries that did not increase their spending. This suggests that changes in healthcare expenditure do have an effect on child mortality, such that more spending reduces child mortality in the future.

Conversely, countries that had increased their spending in 2002 had proportionally higher child mortality rates in the past than countries that did not increase their spending. This implies that child mortality rates are causing changes in healthcare expenditure. This makes sense. For exmaple, countries might decide to increase healthcare spending when there is evidence that the rates are proportionally high.

Thus, it appears that child mortality may be a cause AND effect of changes in healthcare expenditure.

### How long does change take?

One of the interesting aspects of the Figure is that it highlights the considerable time-frame over which these effects operate. For example, the gap in child mortality rates between countries that did or did not increase their spending on health increases years into the future from 2002. We might expect that year-to-year differences caused by increasing expenditure would appear and disappear quickly. However, the gap begins to open, being clear around 2006-2007 (4-5 years in the future), andis still present all the way to 2013 (11 years into the future).

With further consideration, this too makes sense. For example, healthcare expenditure might increase, but, in many cases, it can take a considerable amount of time for those funds to be allocated, or for the outcomes of those funds to be fully realised.


## Sign off

Thanks for reading and I hope this was useful for you.

For updates of recent blog posts, follow [\@drsimonj](https://twitter.com/drsimonj) on Twitter, or email me at <drsimonjackson@gmail.com> to get in touch.

If you'd like the code that produced this blog, check out the [blogR GitHub repository](https://github.com/drsimonj/blogR).